{% extends "base.html" %}

{% block content %}
<div class="hero">
    <h1>ğŸ“š Kontroldarbu Grafiks</h1>
    <p>OrganizÄ“ti pÄ“c priekÅ¡metiem - vienkÄrÅ¡Äk sekot lÄ«dzi!</p>
</div>

<div class="grid-layout">
    <div class="main-content">
        <!-- KALENDÄ€RA LEJUPLÄ€DES POGAS -->
        <div class="calendar-actions">
            <a href="/calendar/all" class="btn btn-calendar">
                ğŸ“… LejupielÄdÄ“t VISU kalendÄru
            </a>
        </div>

        {% if is_host %}
        <div class="actions">
            <a href="/add_subject" class="btn btn-success">ğŸ“ Pievienot priekÅ¡metu</a>
            <a href="/add" class="btn">â• Pievienot darbu</a>
            <a href="/add_homework" class="btn btn-homework">ğŸ“ MÄjasdarbs</a>
            <a href="/import_ics" class="btn" style="background: var(--purple);">ğŸ“¤ ImportÄ“t .ics</a>
        </div>
        {% endif %}

        <!-- PRIEKÅ METU SARAKSTS -->
        <h2 class="section-title">ğŸ“š PriekÅ¡meti</h2>

        <div class="subjects-grid">
            {% for subject in subjects %}
            <div class="test-card subject-card" style="border-left: 5px solid {{ subject.color }}; cursor: pointer;" 
                 onclick="window.location.href='/subject/{{ subject.name }}'">
                <div class="subject-header">
                    <h3>{{ subject.name }}</h3>
                    <span class="subject-badge">
                        {{ work_by_subject[subject.name]|length if subject.name in work_by_subject else 0 }} darbs
                    </span>
                </div>
                
                {% if subject.name in work_by_subject and work_by_subject[subject.name] %}
                    {% set subject_work = work_by_subject[subject.name] %}
                    {% set upcoming_tests = [] %}
                    {% for work in subject_work %}
                        {% if work.type != 'MÄjasdarbs' and work.days_left >= 0 %}
                            {% set _ = upcoming_tests.append(work) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% set next_test = upcoming_tests|sort(attribute='days_left')|first if upcoming_tests else None %}
                    
                    {% if next_test %}
                    <div class="next-test-info">
                        <strong>â° NÄkamais darbs:</strong><br>
                        <span class="type-badge type-{{ next_test.type|lower }}">{{ next_test.type }}</span>
                        {{ next_test.date }}
                        
                        <!-- âœ… NodoÅ¡anas termiÅ†Å¡ -->
                        {% if next_test.due_date and next_test.due_date != next_test.date %}
                        <p style="margin: 5px 0; font-size: 0.9em;">
                            <strong>ğŸ“ NodoÅ¡anas termiÅ†Å¡:</strong> {{ next_test.due_date }}
                        </p>
                        {% endif %}
                        
                        <!-- âœ… KRÄ€SAINAIS DIENU SKAITÄªTÄ€JS -->
                        <div class="new-days-counter">
                            <div class="days-badge days-{{ next_test.days_left }} {% if next_test.days_left > 30 %}large-number{% endif %}">
                                {% if next_test.days_left == 0 %}
                                    ğŸš¨ Å ODIEN
                                {% elif next_test.days_left == 1 %}
                                    âš ï¸ RÄªT
                                {% elif next_test.days_left > 1 and next_test.days_left <= 7 %}
                                    â° {{ next_test.days_left }} dienas
                                {% elif next_test.days_left > 7 %}
                                    ğŸ“… {{ next_test.days_left }} dienas
                                {% else %}
                                    âœ… Pabeigts
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="calendar-link">
                            <a href="/calendar/test/{{ next_test.id }}" class="btn btn-calendar">
                                ğŸ“… KalendÄrÄ
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <p class="no-tests">ğŸ‰ Nav tuvojoÅ¡os kontroldarbu</p>
                    {% endif %}
                {% else %}
                    <p class="no-tests">ğŸ“ VÄ“l nav pievienotu darbu</p>
                {% endif %}
                
                {% if is_host %}
                <div class="subject-actions">
                    <a href="/delete_subject/{{ subject.id }}" class="btn btn-danger" 
                       onclick="return confirm('Vai tieÅ¡Äm dzÄ“st priekÅ¡metu un visus tÄ darbus?')">
                       ğŸ—‘ï¸ DzÄ“st
                    </a>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="test-card empty-subjects">
                <h3>ğŸ“š VÄ“l nav pievienotu priekÅ¡metu</h3>
                <p>
                    {% if is_host %}
                        SÄc ar priekÅ¡metu pievienoÅ¡anu!
                    {% else %}
                        GaidÄm, kad organizators pievienos priekÅ¡metus!
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- VISI TUVOJOÅ IES KONTROLARBI -->
        <h2 class="section-title">â° TuvojoÅ¡ies darbi</h2>

        {% if work_by_subject %}
            {% set all_tests = [] %}
            {% for subject_name, subject_work in work_by_subject.items() %}
                {% for work in subject_work %}
                    {% if work.type != 'MÄjasdarbs' %}
                        {% set _ = all_tests.append(work) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            
            {% set upcoming_tests = all_tests|selectattr('days_left', '>=', 0)|list|sort(attribute='days_left') %}
            
            {% if upcoming_tests %}
                {% for test in upcoming_tests %}
                <div class="test-card">
                    <div class="test-header">
                        <div class="test-info">
                            <h3>
                                {{ test.subject }}
                                <span class="type-badge type-{{ test.type|lower }}">{{ test.type }}</span>
                            </h3>
                            <p class="work-date">
                                <strong>ğŸ“… Datums:</strong> {{ test.date }}
                                {% if test.time and test.time != '23:59' %}
                                    <span class="time-badge">ğŸ•’ {{ test.time }}</span>
                                {% endif %}
                            </p>
                            
                            <!-- âœ… NodoÅ¡anas termiÅ†Å¡ -->
                            {% if test.due_date and test.due_date != test.date %}
                            <p class="work-date">
                                <strong>ğŸ“ NodoÅ¡anas termiÅ†Å¡:</strong> {{ test.due_date }}
                                <span class="due-date-badge">â° LÄ«dz {{ test.due_date }}</span>
                            </p>
                            {% endif %}
                            
                            <!-- âœ… KRÄ€SAINAIS DIENU SKAITÄªTÄ€JS -->
                            <div class="new-days-counter">
                                <div class="days-badge days-{{ test.days_left }} {% if test.days_left > 30 %}large-number{% endif %}">
                                    {% if test.days_left == 0 %}
                                        ğŸš¨ Å ODIEN
                                    {% elif test.days_left == 1 %}
                                        âš ï¸ RÄªT
                                    {% elif test.days_left > 1 and test.days_left <= 7 %}
                                        â° {{ test.days_left }} dienas
                                    {% elif test.days_left > 7 %}
                                        ğŸ“… {{ test.days_left }} dienas
                                    {% else %}
                                        âœ… Pabeigts
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-actions">
                            <a href="/calendar/test/{{ test.id }}" class="btn btn-calendar">
                                ğŸ“… KalendÄrs
                            </a>
                        </div>
                    </div>
                    
                    {% if test.description %}
                    <div class="test-description">
                        <strong>ğŸ“ Apraksts:</strong> {{ test.description }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="test-card empty-state">
                    <h3>ğŸ‰ Nav tuvojoÅ¡os kontroldarbu!</h3>
                    <p>Labs darbs! Visi kontroldarbi ir pabeigti vai plÄnoti tÄlÄkÄ nÄkotnÄ“.</p>
                </div>
            {% endif %}
        {% endif %}

        <div class="actions">
            <a href="/all" class="btn">ğŸ“‹ ApskatÄ«t visus darbus</a>
            <a href="/homework" class="btn btn-homework">ğŸ“ MÄjasdarbi</a>
        </div>
    </div>

    <!-- SÄ€NBARÄ»A -->
    <div class="sidebar">
        <div class="test-card notification-promo" onclick="window.location.href='/notifications'" style="cursor: pointer;">
            <h3>ğŸ”” E-pasta PaziÅ†ojumi</h3>
            <p>SaÅ†em atgÄdinÄjumus par tuvojoÅ¡ajiem darbiem tieÅ¡i e-pastÄ!</p>
            
            <div class="notification-stats">
                <div class="stat-item">
                    <span>ğŸ“§ ReÄ£istrÄ“tie e-pasti:</span>
                    <strong id="registeredEmails">0</strong>
                </div>
                <div class="stat-item">
                    <span>â° AktÄ«vie abonementi:</span>
                    <strong id="activeSubscriptions">0</strong>
                </div>
            </div>
            
            <div class="click-indicator">
                <span class="indicator-text">ğŸ’¡ KlikÅ¡Ä·ini Å¡eit, lai reÄ£istrÄ“tos!</span>
                <span class="indicator-arrow">â¡ï¸</span>
            </div>
            
            <div class="notification-features">
                <div class="feature">âœ… 1 diena pirms darba</div>
                <div class="feature">âœ… 3 dienas pirms darba</div>
                <div class="feature">âœ… IzvÄ“lÄ“ti priekÅ¡meti</div>
            </div>
        </div>

        <!-- Ä€TRA INFORMÄ€CIJA -->
        <div class="test-card info-card">
            <h4>â„¹ï¸ Ä€tra informÄcija</h4>
            <div class="info-list">
                <p>ğŸ“š PriekÅ¡meti: <strong>{{ subjects|length }}</strong></p>
                <p>ğŸ“… Å odien: <strong>{{ now.strftime('%d.%m.%Y') }}</strong></p>
                <p>ğŸ• Laiks: <strong>{{ now.strftime('%H:%M') }}</strong></p>
                <div class="online-counter">
                    <div class="online-dot"></div>
                    <span class="online-text">Online:</span>
                    <span class="online-count" id="onlineCount">0</span>
                </div>
            </div>
        </div>

        <!-- JAUNÄ€KÄ€S ZIÅ…AS -->
        <div class="test-card news-card">
            <h3>ğŸ“¢ JaunÄkÄs ziÅ†as</h3>
            
            {% if news %}
                {% for item in news %}
                <div class="news-item">
                    <div class="news-header">
                        <h4>{{ item.title }}</h4>
                        <span class="news-date">{{ item.date }}</span>
                    </div>
                    
                    {% if item.image_url %}
                    <div class="news-image">
                        {% if item.image_url.endswith('.gif') %}
                        <img src="{{ item.image_url }}" alt="{{ item.title }}">
                        {% else %}
                        <img src="{{ item.image_url }}" alt="{{ item.title }}">
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <p class="news-content">
                        {{ item.content }}
                    </p>
                    
                    {% if is_host %}
                    <div class="news-actions">
                        <a href="/edit_news/{{ item.id }}" class="btn btn-edit">
                            âœï¸ RediÄ£Ä“t
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-news">
                    <p>ğŸ“ VÄ“l nav jaunumu</p>
                    {% if is_host %}
                    <a href="/news" class="btn btn-add-news">
                        â• Pievienot jaunumu
                    </a>
                    {% endif %}
                </div>
            {% endif %}
            
            {% if is_host and news %}
            <div class="news-management">
                <a href="/news" class="btn btn-manage-news">
                    ğŸ“‹ PÄrvaldÄ«t jaunumus
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.grid-layout {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    margin: 2rem 0;
}

.section-title {
    color: var(--text-primary);
    margin: 2rem 0 1rem 0;
    font-size: 1.5rem;
}

.subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.subject-card {
    transition: all 0.3s ease;
}

.subject-card:hover {
    transform: translateY(-5px);
}

.subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.subject-header h3 {
    color: var(--text-primary);
    margin: 0;
}

.subject-badge {
    background: var(--primary);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.next-test-info {
    background: var(--bg-secondary);
    padding: 0.8rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.no-tests {
    color: var(--text-secondary);
    text-align: center;
    padding: 1rem;
}

.subject-actions {
    margin-top: 1rem;
    text-align: center;
}

.empty-subjects {
    text-align: center;
    grid-column: 1 / -1;
}

.test-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
}

.test-info {
    flex: 1;
}

.work-date {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.test-actions {
    display: flex;
    gap: 0.5rem;
}

.test-description {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.empty-state {
    text-align: center;
}

/* SÄ€NBARÄ»AS STILI */
.sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.info-card {
    background: var(--bg-secondary);
}

.info-list {
    font-size: 0.9rem;
}

/* NODOÅ ANAS TERMIÅ…A STILI */
.due-date-badge {
    background: linear-gradient(135deg, #8E44AD, #9B59B6);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 0.5rem;
}

.time-badge {
    background: var(--primary);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .grid-layout {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        order: -1;
    }
    
    .subjects-grid {
        grid-template-columns: 1fr;
    }
    
    .test-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .test-actions {
        align-self: stretch;
        justify-content: flex-end;
    }
}
</style>
{% endblock %}