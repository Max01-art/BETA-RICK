{% extends "base.html" %}

{% block title %}GalvenƒÅ lapa - {{ app_name }}{% endblock %}

{% block styles %}
<style>
    .welcome-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border-left: 6px solid var(--primary-color);
    }
    
    .subject-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    .subject-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
{% set work_by_subject = work_by_subject if work_by_subject is mapping else {} %}

<!-- Welcome section -->
<div class="welcome-card">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3">üìö Kontroldarbu Grafiks</h1>
            <p class="lead mb-4">Organizƒìti pƒìc priek≈°metiem - vienkƒÅr≈°ƒÅk sekot lƒ´dzi!</p>
            
            <div class="d-flex flex-wrap gap-2 mb-3">
                <a href="/calendar/all" class="btn btn-primary btn-lg">
                    <i class="fas fa-calendar-download me-2"></i>LejupielƒÅdƒìt kalendƒÅru
                </a>
                <a href="/all" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-list me-2"></i>Visi darbi
                </a>
            </div>
        </div>
        <div class="col-lg-4 text-center">
            <div class="stat-card">
                <h2 class="display-4 fw-bold">{{ subjects|length }}</h2>
                <p class="mb-0">Priek≈°meti</p>
            </div>
        </div>
    </div>
</div>

<!-- Host actions -->
{% if is_host %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title"><i class="fas fa-tools me-2"></i>Hosta rƒ´ki</h5>
        <div class="d-flex flex-wrap gap-2">
            <a href="/add_subject" class="btn btn-success">
                <i class="fas fa-book me-2"></i>Pievienot priek≈°metu
            </a>
            <a href="/add" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Pievienot darbu
            </a>
            <a href="/add_homework" class="btn btn-info">
                <i class="fas fa-book me-2"></i>MƒÅjasdarbs
            </a>
            <a href="/import_ics" class="btn btn-warning">
                <i class="fas fa-file-import me-2"></i>Importƒìt .ics
            </a>
            <a href="/news" class="btn btn-secondary">
                <i class="fas fa-newspaper me-2"></i>Zi≈Üas
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Subjects grid -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="fas fa-book-open me-2"></i>Priek≈°meti</h4>
        <span class="badge bg-primary">{{ subjects|length }} priek≈°meti</span>
    </div>
    <div class="card-body">
        {% if subjects %}
        <div class="row g-4">
            {% for subject in subjects %}
            {% set subject_work = work_by_subject.get(subject.name, []) %}
            <div class="col-md-6 col-lg-4">
                <div class="card subject-card h-100" onclick="window.location.href='{{ url_for('subject_details_page', subject_name=subject.name) }}'">
                    <div class="card-header" style="border-left: 5px solid {{ subject.color|default('#4361ee') }};">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title mb-0">{{ subject.name }}</h5>
                            <span class="badge rounded-pill" style="background: {{ subject.color|default('#4361ee') }}; color: white;">
                                {{ subject_work|length if subject_work is iterable else 0 }}
                            </span>
                        </div>
                        {% if subject.description %}
                        <p class="card-text text-muted small mt-2">{{ subject.description }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="card-body">
                        {% if subject_work and subject_work is iterable and subject_work|length > 0 %}
                            {# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç #}
                            {% set next_work_found = false %}
                            {% set next_work = none %}
                            {% set next_days = 999 %}
                            
                            {% for work_item in subject_work %}
                                {% if work_item is mapping %}
                                    {% set work_days = work_item.days_left|default(999) %}
                                    {% if work_days >= 0 and work_days < next_days %}
                                        {% set next_work_found = true %}
                                        {% set next_work = work_item %}
                                        {% set next_days = work_days %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if next_work_found %}
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">NƒÅkamais darbs:</small>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>{{ next_work.type|default('NezinƒÅms') }}</strong>
                                        <span class="badge bg-{{ get_status_color(next_days) }}">
                                            {% if next_days == 0 %}
                                                ≈†ODIEN
                                            {% elif next_days == 1 %}
                                                Rƒ™T
                                            {% else %}
                                                {{ next_days }} dienas
                                            {% endif %}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                        {{ format_date(next_work.date|default('')) }}
                                    </small>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                    <p class="mb-0 text-success">Nav tuvojo≈°os darbu</p>
                                </div>
                            {% endif %}
                        {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-plus-circle fa-2x text-primary mb-2"></i>
                            <p class="mb-0 text-muted">Vƒìl nav darbu</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt me-1"></i>
                                {{ subject.created_date|default('') }}
                            </small>
                            <a href="{{ url_for('subject_details_page', subject_name=subject.name) }}" 
                               class="btn btn-sm btn-outline-primary">
                                Apskatƒ´t
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-books fa-3x text-muted mb-3"></i>
            <h4>Vƒìl nav pievienotu priek≈°metu</h4>
            <p class="text-muted mb-4">
                {% if is_host %}
                SƒÅciet ar priek≈°metu pievieno≈°anu!
                {% else %}
                GaidƒÅm, kad organizators pievienos priek≈°metus!
                {% endif %}
            </p>
            {% if is_host %}
            <a href="/add_subject" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i>Pievienot pirmo priek≈°metu
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Upcoming work -->
<div class="card mt-4">
    <div class="card-header">
        <h4 class="mb-0"><i class="fas fa-clock me-2"></i>Tuvojo≈°ies darbi</h4>
    </div>
    <div class="card-body">
        {% if work_by_subject and work_by_subject is mapping %}
            {% set has_upcoming_work = false %}
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Priek≈°mets</th>
                            <th>Tips</th>
                            <th>Datums</th>
                            <th>Atliku≈°ƒÅs dienas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subject_name, subject_work in work_by_subject.items() %}
                            {% if subject_work is iterable %}
                                {% for work_item in subject_work %}
                                    {% if work_item is mapping %}
                                        {% set work_days = work_item.days_left|default(999) %}
                                        {% if work_days >= 0 and work_days <= 14 %}
                                            {% set has_upcoming_work = true %}
                                            <tr>
                                                <td>
                                                    <strong>{{ work_item.subject|default('NezinƒÅms') }}</strong>
                                                    {% if work_item.title|default('') %}<br><small>{{ work_item.title }}</small>{% endif %}
                                                </td>
                                                <td>
                                                    {% set work_type = work_item.type|default('NezinƒÅms') %}
                                                    {% set badge_color = 'warning' if work_type != 'MƒÅjasdarbs' else 'success' %}
                                                    <span class="badge bg-{{ badge_color }}">
                                                        {{ work_type }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {{ format_date(work_item.date|default('')) }}
                                                    {% if work_item.time|default('') and work_item.time != '23:59' %}
                                                    <br><small>{{ work_item.time }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 
                                                        'danger' if work_days == 0 else
                                                        'warning' if work_days == 1 else
                                                        'info' if work_days <= 7 else
                                                        'success'
                                                    }}">
                                                        {% if work_days == 0 %}üö® ≈†ODIEN
                                                        {% elif work_days == 1 %}‚ö†Ô∏è Rƒ™T
                                                        {% else %}{{ work_days }} dienas
                                                        {% endif %}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if not has_upcoming_work %}
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <p class="mb-0 text-success">Nav tuvojo≈°os darbu</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4 class="text-success">üéâ Nav darbu!</h4>
            <p class="text-muted">Pievieno pirmos darbus.</p>
            {% if is_host %}
            <a href="/add" class="btn btn-primary">Pievienot darbu</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}